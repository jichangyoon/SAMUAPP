stages:
  - build
  - test
  - deploy

variables:
  NODE_VERSION: "20.18.2"
  IONIC_CLI_VERSION: "7.2.0"
  CAPACITOR_CLI_VERSION: "7.3.0"

cache:
  paths:
    - node_modules/
    - dist/

before_script:
  - apt-get update -qq && apt-get install -y -qq git curl
  - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
  - apt-get install -y nodejs
  - npm install -g @ionic/cli@${IONIC_CLI_VERSION}
  - npm install -g @capacitor/cli@${CAPACITOR_CLI_VERSION}
  - npm ci

build_web:
  stage: build
  script:
    - npm run build
    - ls -la dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour

build_android:
  stage: build
  dependencies:
    - build_web
  script:
    - apt-get update -qq && apt-get install -y -qq openjdk-17-jdk wget unzip
    - export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
    - wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
    - unzip -q commandlinetools-linux-9477386_latest.zip
    - mkdir -p android-sdk/cmdline-tools/latest
    - mv cmdline-tools/* android-sdk/cmdline-tools/latest/
    - export ANDROID_HOME=$PWD/android-sdk
    - export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
    - yes | sdkmanager --licenses
    - sdkmanager "platforms;android-34" "build-tools;34.0.0" "platform-tools"
    - npx cap sync android
    - cd android
    - ./gradlew assembleDebug
    - cd ..
  artifacts:
    paths:
      - android/app/build/outputs/apk/debug/
    expire_in: 1 week
  only:
    - main
    - develop

test:
  stage: test
  script:
    - npm run check
  dependencies:
    - build_web

deploy:
  stage: deploy
  script:
    - echo "Deploy to production"
  dependencies:
    - build_android
  only:
    - main